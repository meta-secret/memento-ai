version: '3'

env:
  DOCKER_REGISTRY_URL: "https://registry-1.docker.io/v2/"
  DOCKER_REGISTRY_USER:
    sh: task -t hazmat/Taskfile.yml vault_secret_docker_user
  DOCKER_REGISTRY_PASS:
    sh: task -t hazmat/Taskfile.yml vault_secret_docker_pass
  DOCKER_REGISTRY_EMAIL:
    sh: task -t hazmat/Taskfile.yml vault_secret_docker_email

tasks:
  docker_login:
    cmds:
      - echo {{.DOCKER_REGISTRY_PASS}} | docker login --username={{.DOCKER_REGISTRY_USER}} --password-stdin ${DOCKER_REGISTRY_URL}
    silent: true


  # https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
  setup_docker_registry:
    cmds:
      - |-
        kubectl create secret docker-registry docker-registry-secret \
        --docker-server={{.DOCKER_REGISTRY_URL}} \
        --docker-username={{.DOCKER_REGISTRY_USER}} \
        --docker-password={{.DOCKER_REGISTRY_PASS}} \
        --docker-email={{.DOCKER_REGISTRY_EMAIL}} \
        || true
    silent: true

  print_docker_registry_auth:
    cmds:
      - kubectl get secret docker-registry-secret --output="jsonpath={.data.\.dockerconfigjson}" | base64 --decode
