version: '3'

tasks:
  prepare_dependencies:
    vars:
      CHEF_IMAGE_NAME: "lukemathwalker/cargo-chef:latest-rust-1.80-bookworm"
    cmds:
      - |-
        docker run --rm \
          --user=$(id -u) \
          --workdir=/app \
          -v $(pwd)/app:/app \
          {{.CHEF_IMAGE_NAME}} \
          cargo chef prepare --recipe-path /app/recipe.json

  base_build:

    cmds:
      - |
        docker buildx build \
          --load \
          --cache-from type=registry,ref={{.BASE_IMAGE}} \
          --cache-to type=registry,ref={{.BASE_IMAGE}},mode=max \
          --tag {{.BASE_IMAGE}} \
          --file base.dockerfile \
          .
        
        docker push {{.BASE_IMAGE}}
