version: '3'

vars:
  BASE_IMAGE: "nervoset/base:latest"

tasks:
  prepare_dependencies:
    internal: true
    vars:
      CHEF_IMAGE_NAME: "lukemathwalker/cargo-chef:latest-rust-1.77-bookworm"
    cmds:
      - mkdir -p target/chef
      - |-
        docker run --rm \
          --user=$(id -u) \
          --workdir=/app \
          -v $(pwd)/app:/app \
          -v $(pwd)/target/chef:/chef \
          {{.CHEF_IMAGE_NAME}} \
          cargo chef prepare --recipe-path /chef/recipe.json

  base_build:
    internal: true
    cmds:
      - task: prepare_dependencies
      - docker buildx build --tag {{.BASE_IMAGE}} --output type=docker --file base.dockerfile .