version: '3'

set: [pipefail]

includes:
  common: common.yml

tasks:

  build:
    requires:
      vars:
        - IMAGE_NAME
        - APP_NAME
    cmds:
      - task: common:base_build
      - |-
        docker buildx build \
          --tag {{.IMAGE_NAME}} \
          --output type=docker \
          --file build.dockerfile \
          --build-arg="APP_NAME={{ .APP_NAME }}" \
          .

  run:
    requires:
      vars:
        - IMAGE_NAME
        - APP_NAME
        - CONTAINER_NAME
    cmds:
      - mkdir -p config/{{.APP_NAME}}

      - task: build
        vars:
          IMAGE_NAME: "{{.IMAGE_NAME}}"
          APP_NAME: "{{.APP_NAME}}"

      - |-
        docker run --rm {{if .DAEMON}}-d {{end}} \
          --name {{.CONTAINER_NAME}} \
          -v ./config/{{.APP_NAME}}/config.yaml:/app/nervoset/config.yaml \
          -v ./app/{{.APP_NAME}}/resources/:/app/nervoset/resources \
          {{if .HOST_PORT}}-p {{.HOST_PORT}}:{{.DOCKER_PORT}}{{end}} \
          {{.IMAGE_NAME}}

  stop:
    requires:
      vars:
        - APP_NAME
    cmds:
      - docker kill {{.APP_NAME}}

  push:
    requires:
      vars:
        - IMAGE_NAME
        - APP_NAME
    cmds:
      - task: build
        vars:
          IMAGE_NAME: "{{.IMAGE_NAME}}"
      - docker push {{.IMAGE_NAME}}

  container_run:
    requires:
      vars:
        - IMAGE_NAME
        - CONTAINER_NAME
        - APP_NAME
    cmds:
      - task: build
        vars:
          IMAGE_NAME: "{{.IMAGE_NAME}}"
          APP_NAME: "{{.APP_NAME}}"

      - mkdir -p config/{{.APP_NAME}}

      - |-
        docker run -ti --rm \
          --name {{.CONTAINER_NAME}} \
          -v ./config/{{.APP_NAME}}/config.yaml:/app/nervoset/config.yaml \
          -v ./app/{{.APP_NAME}}/resources/:/app/nervoset/resources \
          {{.IMAGE_NAME}} \
          bash
