version: '3'

set: [pipefail]

includes:
  common: common.yml

tasks:

  build:
    requires:
      vars:
        - IMAGE_NAME
        - APP_NAME
    cmds:
      - task: common:base_build
      - mkdir -p app/{{ .APP_NAME }}/resources
      - |-
        docker buildx build \
          --tag {{.IMAGE_NAME}} \
          --output type=docker \
          --file build.dockerfile \
          --build-arg="APP_NAME={{ .APP_NAME }}" \
          .

  push:
    requires:
      vars:
        - IMAGE_NAME
        - APP_NAME
    cmds:
      - task: build
        vars:
          IMAGE_NAME: "{{.IMAGE_NAME}}"
      - docker push {{.IMAGE_NAME}}
